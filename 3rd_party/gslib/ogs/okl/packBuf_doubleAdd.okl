







@kernel void packBuf_doubleAdd(const dlong N,
                                    const int Nentries,
                                    const dlong stride,
                                    @restrict const  dlong *  gatherStarts,
                                    @restrict const  dlong *  gatherIds,
                                    @restrict const  dlong *  scatterStarts,
                                    @restrict const  dlong *  scatterIds,
                                    @restrict double *  q, 
                                    @restrict double *  qout)
{
  for(dlong g=0;g<N*Nentries;++g;@tile(p_blockSize,@outer,@inner)){
    
    const dlong gid = g%N;
    const int k = g/N;
    const dlong startGather = gatherStarts[gid];
    const dlong endGather = gatherStarts[gid+1];
    const dlong startScatter = scatterStarts[gid];
    const dlong endScatter = scatterStarts[gid+1];

    double gq = 0.0;
    for(dlong n=startGather;n<endGather;++n){
      const dlong id = gatherIds[n];
      gq += q[id+k*stride];
    }
    for(dlong n=startGather;n<endGather;++n){
      const dlong id = gatherIds[n];
      q[id+k*stride] = gq;
    }

    for(dlong n=startScatter;n<endScatter;++n){
      const dlong id = scatterIds[n];
      qout[id*Nentries+k] = gq;
    }
  }
}
