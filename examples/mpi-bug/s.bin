#!/bin/bash
#SBATCH -A CSC262
#SBATCH -J nekRS_mpi-bug
#SBATCH -o %x-%j.out
#SBATCH -t 00:30:00
#SBATCH -N 8
#SBATCH -p batch
#SBATCH --exclusive
#SBATCH --ntasks-per-node=8
#SBATCH --gpus-per-task=1
#SBATCH --gpu-bind=closest
#SBATCH --cpus-per-task=8
module load PrgEnv-gnu
module load craype-accel-amd-gfx90a
module load cray-mpich
module load rocm
module unload cray-libsci
module list
rocm-smi
rocm-smi --showpids
export MPICH_GPU_SUPPORT_ENABLED=1
export PE_MPICH_GTL_DIR_amd_gfx90a="-L/opt/cray/pe/mpich/8.1.16/gtl/lib"
export PE_MPICH_GTL_LIBS_amd_gfx90a="-lmpi_gtl_hsa"
ulimit -s unlimited 
export NEKRS_HOME=/gpfs/alpine/scratch/malachi/csc262/installs/nekrs-crusher-v22.0-early-prepost
export NEKRS_GPU_MPI=1 
export NVME_HOME=/mnt/bb/malachi/
export ROMIO_HINTS=/gpfs/alpine/scratch/malachi/csc262/mpi-bug/.romio_hint


###
export FI_MR_CACHE_MAX_COUNT=0

### show me my env vars
export MPICH_ENV_DISPLAY=1

# actual run
date
srun -n 64 /gpfs/alpine/scratch/malachi/csc262/installs/nekrs-crusher-v22.0-early-prepost/bin/nekrs --backend HIP --device-id 0 --setup mpi-bug
